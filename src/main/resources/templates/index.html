<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
        xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link th:rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.5/css/bootstrap.min.css}" />

    <style>
        .hover-user {
            position: relative;
        }

        .hover-user .action-buttons {
            display: none;
            margin-top: 4px;
        }

        .hover-user:hover .action-buttons {
            display: block;
        }
        .hover-project {
            position: relative;
            padding-bottom: 1em; 
        }
        .hover-project:hover .action-buttons {
            opacity: 1;     
        }
        .hover-project .action-buttons {
            display: block;
            height: 0.8em;       
            opacity: 0;          
            margin-top: 0.5em;
            text-align: right;
            transition: opacity 0.3s ease;
        }

        .hover-tasks {
            position: relative;
        }


        .hover-tasks .action-buttons {
            display: none;
        }

        .hover-tasks:hover .action-buttons {
            display: inline-block;
        }

        .task-item {
            position: relative;
            padding: 4px;
            transition: background-color 0.3s ease;
        }


        .edit-task-btn {
            display: none;
            margin-left: 10px;
        }

        .task-item:hover .edit-task-btn {
            display: inline;
        }

       
    </style>

</head>
<body>
<div class="container" style="padding-bottom: 100px;">
    <h1>Task Manager</h1>
    <hr />

    <!-- <h4 class="mt-4">BASIC USERS</h4> -->
    <table class="table table-bordered table-striped">
        <thead>
        <tr>
            <th>Username</th>
            <th>Projects</th>
            <th>Tasks</th>
            <th sec:authorize="hasRole('ADMIN')">Actions</th>

        </tr>
        
        </thead>


        <tbody>
            <th:block th:each="user : ${users}"  th:if="${user.role.name() == 'BASIC'}">
                <tr th:if="${#lists.isEmpty(user.projects)}">
                    <td class="hover-user">
                        <div >
                            <span th:text="${user.username}"></span>
                        </div>
                        <div th:if="${user.username != #authentication.name}" sec:authorize="hasRole('ADMIN')" class="action-buttons">
                            <a th:href="@{'/admin/users/' + ${user.id} + '/edit'}" class="btn btn-sm btn-outline-primary">Edit</a>
                            <!--<a th:href="@{'/admin/users/' + ${user.id} + '/delete'}" class="btn btn-sm btn-outline-danger">Delete</a>-->
                        </div>
                    </td>
                    <td>-</td>
                    <td>-</td>
                    <td sec:authorize="hasRole('ADMIN')" th:if="${user.role.name() == 'BASIC'}">
                            <a th:href="@{'/admin/users/' + ${user.id} + '/assign-project'}"
                            class="btn btn-sm btn-outline-primary">
                                Assign Project
                            </a>
                    </td>
                </tr>

                <tr th:each="project, projStat : ${user.projects}" th:if="${!#lists.isEmpty(user.projects)}">
                    <td th:if="${projStat.index == 0}" 
                        th:rowspan="${#lists.size(user.projects)}"
                        class="hover-user">


                        <div> 
                            <span th:text="${user.username}"></span>
                        </div>
                        <div sec:authorize="hasRole('ADMIN')" class="action-buttons">
                            <a th:href="@{'/admin/users/' + ${user.id} + '/edit'}" class="btn btn-sm btn-outline-primary">Edit</a>
                            <!--<a th:href="@{'/admin/users/' + ${user.id} + '/delete'}" class="btn btn-sm btn-outline-danger">Delete</a>-->
                        </div>
                        
                    </td>


<!-- PROJECT INFO -->
                    <td>
                        <div class="hover-project">
                            <strong th:text="${project.name}"></strong><br />
                            <em th:text="${project.description}"></em><br />
                            <span th:if="${project.deadline != null}" th:text="'Deadline: ' + ${#temporals.format(project.deadline, 'yyyy-MM-dd')}"></span>
                            <span th:unless="${project.deadline != null}">Deadline: No deadline</span><br />
                            <span th:text="'Completed: ' + (${project.isComplete} ? 'Yes' : 'No')"></span>
                            <span sec:authorize="hasRole('ADMIN')" class="action-buttons">
                                <a th:href="@{'/admin/projects/' + ${project.id} + '/edit'}" class="btn btn-sm btn-outline-primary">Edit</a>
                                <!--<a th:href="@{'/admin/users/' + ${user.id} + '/delete'}" class="btn btn-sm btn-outline-danger">Delete</a>-->
                                <form th:action="@{'/admin/users/' + ${user.id} + '/projects/' + ${project.id} + '/remove'}" 
                                    method="post"
                                    style="display:inline"
                                    onsubmit="return confirm('Remove this project only from this user?');">
                                    <button type="submit" class="btn btn-sm btn-outline-warning">Remove</button>
                                </form>
                            </span>
                            

                            
                        </div>
                    </td>

<!-- TASKS INFO -->
                    <td>
                        <div class="hover-tasks">
                            <span th:if="${#lists.isEmpty(project.tasks)}">-</span>
                            
                            <div th:each="task : ${project.tasks}" class="task-item">
                                <!-- TASK INFO -->
                                <span th:text="${task.description}"></span>
                                <span th:text=" ${task.priority} "></span>
                                <span th:text="${task.status} "></span>
                                <span th:text="${#temporals.format(task.deadline, 'yyyy-MM-dd')}"></span>

                                <!-- HOVER EDIT BUTTON -->
                                <span sec:authorize="hasRole('ADMIN')" class="edit-task-btn">
                                    <a th:href="@{'/admin/tasks/' + ${task.id} + '/edit'}" class="btn btn-sm btn-outline-secondary">Edit</a>
                                </span>
                            </div>

                            <!-- ADD TASK BUTTON -->
                            <div sec:authorize="hasRole('ADMIN')" class="action-buttons">
                                <a th:href="@{'/admin/projects/' + ${project.id} + '/add-task'}" class="btn btn-sm btn-outline-primary">Add Task</a>
                            </div>
                        </div>
                    </td>


<!-- Assign Project button, only on first project row -->
                    <td th:if="${projStat.index == 0 and user.role.name() == 'BASIC'}" th:rowspan="${#lists.size(user.projects)}" sec:authorize="hasRole('ADMIN')">
                            <a th:href="@{'/admin/users/' + ${user.id} + '/assign-project'}"
                            class="btn btn-sm btn-outline-primary">
                                Assign Project
                            </a>
                    </td>


                </tr>
            </th:block>
        </tbody>


        


    </table>
<!-- Admins Section -->
<h4 class="mt-4">ADMINS</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Username</th>
                <!-- Only show this header if user is admin -->
                <th th:if="${#authorization.expression('hasRole(''ADMIN'')')}">Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="admin : ${users}" th:if="${admin.role.name() == 'ADMIN'}">
                <td th:text="${admin.username}"></td>
                
                <!-- only if current viewer is admin -->
                <td th:if="${#authorization.expression('hasRole(''ADMIN'')')}">
                    <a th:if="${admin.username != #authentication.name}"
                    th:href="@{'/admin/users/' + ${admin.id} + '/edit'}"
                    class="btn btn-sm btn-outline-primary">
                        Edit
                    </a>
                </td>
            </tr>
        </tbody>
    </table>



   <p sec:authorize="hasRole('ADMIN')">
        <a class="btn btn-outline-success" th:href="@{/admin/invite-user}">
            <i class="bi bi-plus-square-fill"></i> invite user
        </a>
    </p>
    <p>Logged in as: <span th:text="${#authentication.name}"></span>
        <span sec:authorize="hasRole('ADMIN')"> (Admin)</span>
        <span sec:authorize="hasRole('BASIC')"> (Basic User)</span>
    </p>



</div>
<!--footer menu at bottom-->
<footer class="mt-auto py-3 bg-light border-top fixed-bottom">
    <div class="container d-flex justify-content-center gap-3">
        <form th:action="@{/logout}" method="post" style="display: inline;">
            <button type="submit" class="btn btn-outline-secondary">Logout</button>
        </form>

        <a class="btn btn-outline-secondary" href="/edit">Edit my Account</a>
    </div>
</footer>
<script th:src="@{/webjars/bootstrap/5.3.5/js/bootstrap.min.js}"></script>
</body>
</html>

